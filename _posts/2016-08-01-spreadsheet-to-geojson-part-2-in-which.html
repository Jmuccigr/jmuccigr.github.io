---
type: posts
title: 'Spreadsheet to GeoJSON: Part 2, in which I do not re-invent the wheel'
date: '2016-08-01T17:35:00.001-04:00'
author: John D. Muccigrosso
tags:
- DH
- Google
- technology
- temples
modified_time: '2016-08-01T17:35:24.248-04:00'
thumbnail: /images/Screenshot%2B2016-08-01%2B17.21.57.png
blogger_id: tag:blogger.com,1999:blog-1655741187746617571.post-2070476156983564606
blogger_orig_url: http://de-vita-sua.blogspot.com/2016/08/spreadsheet-to-geojson-part-2-in-which.html
---

<a href="{% post_url 2016-07-08-google-sheets-to-geojson %}" target="_blank">My last post</a> was about doing a simple, but automated conversion of our growing Google sheet of Roman temples into GeoJSON. At the end, I noted that there were some existing methods for doing that, and in the interim I’ve been exploring those a bit.<br /><br />Most of them involve some kind of javascript and are designed for use on websites (or with node). That’s pretty nice in some circumstances, and in fact I’ve been playing around with them, trying to improve my <a href="https://leafletjs.com/">leaflet.js</a> skills in the process.<br /><br />However I’m still interested in being able to download our data and convert all of it to GeoJSON which gets posted to GitHub, for which javascript isn’t ideal (and I think I could make it work, if I knew js better), but there is some software out there that means I don’t have to worry about the actual conversion from sheet to json, though I do have to do some clean up. Ideally the script will not require any interaction, and it will convert <strong>all</strong> the data we have into GeoJSON, not just the bits that I tell it about. This will let us add and delete columns in the sheet without worrying about whether it will screw up the conversion.<br /><h1 id="toc_0">The Details</h1><table cellpadding="0" cellspacing="0" class="tr-caption-container" style="float: right; margin-left: 1em; text-align: right;"><tbody><tr><td style="text-align: center;"><a href="/images/Screenshot%2B2016-08-01%2B17.21.57.png" imageanchor="1" style="clear: right; margin-bottom: 1em; margin-left: auto; margin-right: auto;"><img alt="Temples and Mithraea around Rome." border="0" height="221" src="/images/Screenshot%2B2016-08-01%2B17.21.57.png" title="" width="400" /></a></td></tr><tr><td class="tr-caption" style="text-align: center;">Temples and mithraea mapped in the area of Rome.</td></tr></tbody></table>I settled on the nifty ogr2ogr utility from <a href="http://gdal.org/">GDAL</a>, the Geospatial Data Abstraction Library, to do the conversion (or conversion<strong>s</strong>, as it turned out), and still did some cleanup with <a href="https://stedolan.github.io/jq/"><em>jq</em></a> and the usual text-manipulation tools. The script was written in bash, so it can be run from the command line (or automatically via cron, or LaunchDaemon these days, I guess). Here’s how the script goes:<br /><ol><li>Download the sheet from Google as xml: <code>https://spreadsheets.google.com/feeds/list/key/1/public/values</code>, where <q>key</q> is the key for the sheet. Pretty sure that I can get csv if I authenticate to Google, but I couldn’t figure out how to do that in a timely way, so I stuck with the public feed. When I tried to download those versions via the browser, it did work, likely because I’m logged into Google services all the time, but possibly because Google doesn’t like people using <code>curl</code> to get data, but will allow a real browser to. In either case, I didn’t want to have to rely on the browser for this, so I stuck with what I could get via the command line.</li><li>Reformat and clean up the xml with <code>tidy -xml -iq</code> and then <code>sed 's/gsx://g'</code>. (Google <strong>really</strong> likes those <q>gsx</q> prefixes on the field names.)</li><li>Use <em>ogr2ogr</em> to convert the xml to csv. ogr2ogr seems to need files to work on, so at this point I also stored the data in temporary files. (Happy to be wrong about the necessity for files, so let me know!)</li><li>Now use <em>ogr2ogr</em> again, the time to convert the csv to GeoJSON. You’d think I could convert the xml directly to GeoJSON, but, again, I couldn’t figure that out (.vrt files) and so resorted to the double conversion. Help welcome!</li><li>At this point, I do a little more clean up, getting rid of some fields from the xml that I don’t want (via <em>grep</em>, <em>jq</em>, and <em>perl</em>) and removing the false 0,0 coordinates that get generated instead of <em>null</em> when the sheet cells for longitude and latitude are empty. </li><li>Finally I save the resultant file to my GitHub sync folder. I also generate a version that has only entries with coordinates, which can be mapped without complaints. That last is handled with <em>jq</em> and <em>tr</em>.</li></ol>In the end then I’ve got a nice little script that does the job. Some improvements include getting ogr2ogr to do the xml-to-GeoJSON directly and using Google auth codes to avoid having to have a public sheet. One thing perhaps best left for another script is the creation of leaflet-related properties connected to how the icon gets displayed (icon color, image, <i>etc</i>.).<br /><br />As usual the script is up <a href="https://github.com/Jmuccigr/temples/blob/master/scripts/ggl2geojson.sh">on GitHub</a>, where it’s annotated with more detail, and you can see the resultant map <a href="https://github.com/Jmuccigr/temples/blob/master/maps/temples.json">up there too</a>&nbsp;(the area around Rome is shown in the image up above).
